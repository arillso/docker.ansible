---
name: Security Scanning

"on":
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    schedule:
        - cron: "0 2 * * 1" # Weekly Monday 02:00 UTC
    workflow_call:

permissions:
    contents: read
    security-events: write

jobs:
    trivy:
        name: Trivy Scan
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

            - name: Build image for scanning
              uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
              with:
                  context: .
                  push: false
                  load: true
                  tags: ansible:scan
                  cache-from: type=registry,ref=ghcr.io/arillso/ansible-cache:latest
                  cache-to: type=gha,mode=max
                  provenance: false
                  sbom: false

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@0.34.0
              with:
                  image-ref: "ansible:scan"
                  format: "sarif"
                  output: "trivy-results.sarif"
                  severity: "CRITICAL,HIGH"

            - name: Upload Trivy scan results
              uses: github/codeql-action/upload-sarif@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

    secrets:
        name: Secret Scanning
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
              with:
                  fetch-depth: 0

            - name: TruffleHog scan
              uses: trufflesecurity/trufflehog@7c0734f987ad0bb30ee8da210773b800ee2016d3 # v3.93.4
              with:
                  path: ./
                  base: ${{ github.event.pull_request.base.sha || 'HEAD~1' }}
                  head: HEAD
                  extra_args: --only-verified
