---
name: Security

"on":
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    schedule:
        - cron: "0 2 * * 1" # Weekly Monday 02:00 UTC

permissions:
    contents: read
    security-events: write

jobs:
    trivy:
        name: Trivy Scan
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

            - name: Build image for scanning
              run: |
                  docker build -t ansible:scan .

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@18f2510ee396bbf400402947b394f2dd8c87dbb0 # v0.29
              with:
                  image-ref: "ansible:scan"
                  format: "sarif"
                  output: "trivy-results.sarif"
                  severity: "CRITICAL,HIGH"

            - name: Upload Trivy scan results
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

    secrets:
        name: Secret Scanning
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
              with:
                  fetch-depth: 0

            - name: Gitleaks scan
              uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
