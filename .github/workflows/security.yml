---
name: Security Scanning

"on":
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    schedule:
        - cron: "0 2 * * 1" # Weekly Monday 02:00 UTC
    workflow_call:

permissions:
    contents: read
    security-events: write

jobs:
    trivy:
        name: Trivy Scan
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349 # v3

            - name: Build image for scanning
              uses: docker/build-push-action@4f58ea79222b3b9dc2c8bbdd6debcef730109a75 # v6
              with:
                  context: .
                  push: false
                  load: true
                  tags: ansible:scan
                  cache-from: |
                      type=registry,ref=ghcr.io/arillso/ansible:buildcache
                      type=gha
                  cache-to: type=gha,mode=max
                  provenance: false
                  sbom: false

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@18f2510ee396bbf400402947b394f2dd8c87dbb0 # v0.29
              with:
                  image-ref: "ansible:scan"
                  format: "sarif"
                  output: "trivy-results.sarif"
                  severity: "CRITICAL,HIGH"

            - name: Upload Trivy scan results
              uses: github/codeql-action/upload-sarif@v4
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

    secrets:
        name: Secret Scanning
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
              with:
                  fetch-depth: 0

            - name: TruffleHog scan
              uses: trufflesecurity/trufflehog@ef6e76c3c4023279497fab4721ffa071a722fd05 # v3.92.4
              with:
                  path: ./
                  base: ${{ github.event.pull_request.base.sha || 'HEAD~1' }}
                  head: HEAD
                  extra_args: --only-verified
