---
name: Deployment

"on":
    push:
        branches:
            - main
        paths:
            - "Dockerfile"
            - "requirements.txt"
    workflow_dispatch:

concurrency:
    group: deploy-${{ github.ref }}
    cancel-in-progress: false

permissions:
    contents: write
    packages: write
    security-events: write
    actions: read
    pull-requests: write

jobs:
    # Run CI and Security in parallel
    ci:
        name: CI
        uses: ./.github/workflows/ci.yml
        secrets: inherit
        permissions:
            contents: read
            security-events: write
            actions: read
            pull-requests: write

    security:
        name: Security
        uses: ./.github/workflows/security.yml
        secrets: inherit
        permissions:
            contents: read
            security-events: write

    # Deploy after CI and Security pass
    deploy:
        name: Build, Push and Release
        runs-on: ubuntu-latest
        needs: [ci, security]
        steps:

            - name: Checkout
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Get version info
              id: version
              run: |
                  ansible_version="$(grep '^ansible-core==' requirements.txt | cut -d'=' -f3)"
                  release_date="$(date '+%Y-%m-%d')"
                  echo "ansible_version=${ansible_version}" >> "$GITHUB_OUTPUT"
                  echo "release_tag=${release_date}" >> "$GITHUB_OUTPUT"

            - name: Check if release exists
              id: check
              run: |
                  if gh release view "${{ steps.version.outputs.release_tag }}" > /dev/null 2>&1; then
                    echo "exists=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "exists=false" >> "$GITHUB_OUTPUT"
                  fi
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Get all changes for today
              id: changes
              run: |
                  release_tag="${{ steps.version.outputs.release_tag }}"

                  # Get all commits from today (00:00 UTC to now)
                  today_start="${release_tag}T00:00:00Z"
                  commits=$(git log --since="$today_start" --pretty=format:"%H|%s|%b" --no-merges)

                  # Get diff for requirements.txt and Dockerfile since last release or today's start
                  last_tag=$(gh release list --limit 1 --json tagName -q '.[0].tagName' 2>/dev/null || echo "")

                  if [ -n "$last_tag" ] && [ "$last_tag" != "$release_tag" ]; then
                    diff_output=$(git diff "$last_tag"..HEAD -- requirements.txt Dockerfile 2>/dev/null || echo "")
                  else
                    # If today's release exists, get all changes since yesterday
                    yesterday=$(date -u -d "yesterday" '+%Y-%m-%d' 2>/dev/null || date -u -v-1d '+%Y-%m-%d')
                    diff_output=$(git diff --since="$today_start" -- requirements.txt Dockerfile 2>/dev/null || echo "")
                  fi

                  # Save data to files
                  echo "$commits" > /tmp/commits.txt
                  echo "$diff_output" > /tmp/changes.diff
                  echo "commits_file=/tmp/commits.txt" >> "$GITHUB_OUTPUT"
                  echo "diff_file=/tmp/changes.diff" >> "$GITHUB_OUTPUT"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Generate release notes with AI
              id: ai_notes
              run: |
                  diff_content=$(cat /tmp/changes.diff)
                  commits_content=$(cat /tmp/commits.txt)
                  ansible_version="${{ steps.version.outputs.ansible_version }}"
                  release_tag="${{ steps.version.outputs.release_tag }}"

                  # Prepare the prompt with all today's commits
                  prompt="Analyze all changes from today ($release_tag) for an Ansible Docker container project and generate release notes in Keep a Changelog format (https://keepachangelog.com).

                  Current Ansible version: ${ansible_version}

                  All commits from today (format: HASH|Subject|Body):
                  ${commits_content}

                  File changes (Dockerfile and requirements.txt):
                  ${diff_content}

                  Generate comprehensive release notes covering ALL commits from today. Use Keep a Changelog sections (Added, Changed, Removed, Fixed, Security). Use German for package names but English section headers. Be concise but include all significant changes. Format as markdown list items starting with '- '. Do not include the version header, just the sections."

                  # Call Anthropic API (supports both API key and OAuth token)
                  response=$(curl -s https://api.anthropic.com/v1/messages \
                    -H "Content-Type: application/json" \
                    -H "Authorization: Bearer $CLAUDE_CODE_OAUTH_TOKEN" \
                    -H "anthropic-version: 2023-06-01" \
                    -d "$(jq -n \
                      --arg prompt "$prompt" \
                      '{
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1024,
                        messages: [{role: "user", content: $prompt}]
                      }')")

                  # Extract the text from response
                  changelog_notes=$(echo "$response" | jq -r '.content[0].text // "### Changed\n\n- Updated Ansible Core to '"${ansible_version}"'"')

                  # Get short SHA for image tags
                  git_sha_short=$(git rev-parse --short HEAD)
                  git_sha_long=$(git rev-parse HEAD)

                  # Extract versions from Dockerfile
                  alpine_version=$(grep '^FROM alpine:' Dockerfile | head -1 | sed -E 's/.*alpine:([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
                  python_version=$(grep "'python3>=" Dockerfile | head -1 | sed -E "s/.*'python3>=([0-9]+\.[0-9]+).*/\1/")

                  # Extract mitogen version from requirements.txt
                  mitogen_version=$(grep '^mitogen==' requirements.txt | cut -d'=' -f3)

                  # Create enhanced release notes for GitHub
                  {
                    echo "This is a rolling release Docker image based on **Ansible Core ${ansible_version}**."
                    echo ""
                    echo "## ðŸ“¦ Container Information"
                    echo ""
                    echo "- **Ansible Core Version:** ${ansible_version}"
                    echo "- **Base Image:** Alpine Linux ${alpine_version}"
                    echo "- **Python Version:** ${python_version}"
                    echo "- **Performance:** Mitogen ${mitogen_version} for 10x faster execution"
                    echo "- **Architecture:** Multi-platform (linux/amd64, linux/arm64)"
                    echo ""
                    echo "**Included Tools & Integrations:**"
                    echo "- **Cloud Platforms:** AWS (boto3), Azure, GCP, OpenShift"
                    echo "- **Kubernetes:** kubectl, helm, kustomize, kubernetes-python"
                    echo "- **Version Control:** git, GitLab API"
                    echo "- **Databases:** PostgreSQL, MySQL, Redis"
                    echo "- **VMware:** pyvmomi"
                    echo "- **Security:** Vault (hvac), CrowdStrike, Consul"
                    echo "- **Windows:** pywinrm with CredSSP"
                    echo "- **Utilities:** jq, gnupg, openssh, rsync, curl"
                    echo ""
                    echo "- **Git SHA:** \`${git_sha_long}\`"
                    echo ""
                    echo "## ðŸ³ Container Images"
                    echo ""
                    echo "**Version Tags:**"
                    echo "- \`arillso/ansible:${ansible_version}\`"
                    echo "- \`arillso/ansible:latest\`"
                    echo "- \`ghcr.io/arillso/ansible:${ansible_version}\`"
                    echo "- \`ghcr.io/arillso/ansible:latest\`"
                    echo ""
                    echo "**SHA Tags:**"
                    echo "- \`arillso/ansible:${ansible_version}-${git_sha_short}\`"
                    echo "- \`arillso/ansible:${ansible_version}-${git_sha_long}\`"
                    echo "- \`ghcr.io/arillso/ansible:${ansible_version}-${git_sha_short}\`"
                    echo "- \`ghcr.io/arillso/ansible:${ansible_version}-${git_sha_long}\`"
                    echo ""
                    echo "## ðŸ“ Changes"
                    echo ""
                    echo "$changelog_notes"
                    echo ""
                    echo "## ðŸš€ Usage"
                    echo ""
                    echo '```bash'
                    echo "# Use specific Ansible version"
                    echo "docker run --rm -v \$(pwd):/workspace arillso/ansible:${ansible_version} ansible-playbook playbook.yml"
                    echo ""
                    echo "# Use latest version"
                    echo "docker run --rm -v \$(pwd):/workspace arillso/ansible:latest ansible-playbook playbook.yml"
                    echo '```'
                    echo ""
                    echo "## ðŸ“– Documentation"
                    echo ""
                    echo "For more information, see the [project documentation](https://github.com/arillso/docker.ansible)."
                  } > /tmp/release_notes.md

                  echo "notes_file=/tmp/release_notes.md" >> "$GITHUB_OUTPUT"
              env:
                  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

            - name: Update or create changelog entry
              id: update_changelog
              run: |
                  tag="${{ steps.version.outputs.release_tag }}"
                  notes=$(cat /tmp/release_notes.md)
                  exists="${{ steps.check.outputs.exists }}"

                  if [ "$exists" = "true" ]; then
                    # Update existing entry in changelog
                    echo "Updating existing changelog entry for $tag"
                    # Remove old entry and add new one
                    sed -i.bak "/^## \[${tag}\]/,/^## \[/{ /^## \[${tag}\]/!{ /^## \[/!d; }; }" CHANGELOG.md
                    {
                      head -n 7 CHANGELOG.md
                      echo ""
                      echo "## [${tag}]"
                      echo ""
                      echo "$notes"
                      echo ""
                      tail -n +8 CHANGELOG.md | sed "/^## \[${tag}\]/,/^## \[/d"
                    } > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md
                    rm -f CHANGELOG.md.bak
                  else
                    # Create new changelog entry
                    echo "Creating new changelog entry for $tag"
                    {
                      head -n 7 CHANGELOG.md
                      echo ""
                      echo "## [${tag}]"
                      echo ""
                      echo "$notes"
                      echo ""
                      tail -n +8 CHANGELOG.md
                    } > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md
                  fi

            - name: Commit changelog
              run: |
                  if git diff --quiet CHANGELOG.md; then
                    echo "No changes to commit"
                    exit 0
                  fi

                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add CHANGELOG.md
                  git commit -m "chore: update changelog for ${{ steps.version.outputs.release_tag }}"
                  git push

            - name: Set up QEMU
              uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3
              with:
                  driver-opts: |
                      network=host
                      image=moby/buildkit:latest

            - name: Docker meta
              id: meta
              uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
              with:
                  images: |
                      ghcr.io/arillso/ansible
                      arillso/ansible
                  tags: |
                      type=raw,value=latest
                      type=raw,value=${{ steps.version.outputs.ansible_version }}
                      type=sha,prefix=${{ steps.version.outputs.ansible_version }}-
                      type=sha,format=long,prefix=${{ steps.version.outputs.ansible_version }}-

            - name: Login to DockerHub
              uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
              with:
                  username: sbaerlocher
                  password: ${{ secrets.DOCKER_TOKEN }}

            - name: Login to GitHub Container Registry
              uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push
              uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
              with:
                  context: .
                  build-args: |
                      ANSIBLE_VERSION=${{ steps.version.outputs.ansible_version }}
                      VCS_REF=${{ github.sha }}
                      BUILD_DATE=${{ steps.version.outputs.release_tag }}
                  push: true
                  platforms: linux/amd64,linux/arm64
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: |
                      type=registry,ref=ghcr.io/arillso/ansible:buildcache
                      type=gha
                  cache-to: |
                      type=registry,ref=ghcr.io/arillso/ansible:buildcache,mode=max
                      type=gha,mode=max
                  provenance: false
                  sbom: false

            - name: Create or Update Release
              uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
              with:
                  tag_name: ${{ steps.version.outputs.release_tag }}
                  name: ${{ steps.version.outputs.release_tag }}
                  body_path: /tmp/release_notes.md
                  make_latest: true
                  generate_release_notes: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
